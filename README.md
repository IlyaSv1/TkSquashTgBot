# TkSquashTgBot

Телеграм-бот для приёма вопросов от пользователей и пересылки их команде Турнирного комитета (ТК АСК). Администраторы могут отвечать на вопросы напрямую в админском чате, а бот автоматически доставляет ответы пользователям.

---

### Функциональность
- Приём вопросов от пользователей (текст или медиа: фото, документ, видео, аудио).
- Пересылка вопросов в админский чат с инструкцией «Ответь на это сообщение реплаем».
- Отправка ответов пользователям и возможность редактирования уже отправленных ответов.
- Логирование всех действий и ошибок.

---

### Команды
/start — приветствие и краткая инструкция для пользователя.

/chatid — вывод ID текущего чата (полезно для тестирования и админов).

---

### Работа с пользователями
1. Пользователь отправляет вопрос в личный чат с ботом.
2. Бот проверяет наличие текста или медиа.
3. Генерируется уникальный идентификатор вопроса (QID) через short_id().
4. Вопрос сохраняется в SQLite базе данных (qmap).
5. Вопрос пересылается в чат администраторов с инструкцией ответить реплаем.
6. Администратор отвечает в чате, бот автоматически отправляет ответ пользователю.

---

### Работа с администраторами
Ответ на вопрос: on_admin_reply отправляет ответ пользователю, сохраняя ID сообщения и тип ответа.

Редактирование ответа: on_admin_edit обновляет сообщение с ответом, если администратор изменил текст в чате.

Закрепление и открепление вопросов: вопросы закрепляются для удобства и открепляются после ответа.

---

### База данных

SQLite база данных хранится в файле qa_bot.sqlite3 (можно изменить через переменную окружения BOT_DB_PATH).

---

### Таблица QMAP

| Поле | Тип | Описание |
|------|-----|-----------|
| qid | TEXT | Уникальный идентификатор вопроса (PRIMARY KEY) |
| user_chat_id | INTEGER | ID чата пользователя |
| user_message_id | INTEGER | ID сообщения с вопросом |
| question_text | TEXT | Текст вопроса |
| question_file_id | TEXT | ID файла с вопросом |
| answer_message_id | INTEGER | ID сообщения с ответом |
| answer_file_id | TEXT | ID файла с ответом |
| answered | INTEGER | Статус ответа (0 — не отвечено, 1 — отвечено) |
| created_at | TIMESTAMP | Дата создания записи |

---

### Конфигурация
Файл .env:

```bash
BOT_TOKEN=ваш_токен_бота
ADMINS_CHAT_ID=ID_чата_админов
```

- BOT_TOKEN — токен Telegram-бота.
- ADMINS_CHAT_ID — ID чата, в который бот будет отправлять вопросы админам.

---

### Вспомогательные утилиты

- utils/helpers.py — генерация короткого идентификатора вопроса (short_id).
- utils/logger.py — настраиваемый логгер для консоли и файла bot.log.
- utils/user_formatter.py — функции для удобного форматирования пользователей в логах и для админов.

---

### Установка

### 1. Клонировать репозиторий:
```bash
git clone <репозиторий>
cd TkSquashTgBot
```

### 2. Установить зависимости:
```bash
pip install -r requirements.txt
```

### 3. Создать файл .env с токеном бота и ID админ-чата.

### 4. Инициализировать базу данных:
```bash
from database.db import init_db
import asyncio

asyncio.run(init_db())
```

### 5. Запустить бота:
```bash
python tgbot.py
```

---

### Логирование

Все действия бота и ошибки записываются в файл bot.log и выводятся в консоль.

---

### Структура проекта
```bash
TkSquashTgBot/
├─ database/
│  └─ db.py               # Работа с SQLite базой данных
├─ handlers/
│  ├─ commands.py         # Команды /start и /chatid
│  ├─ user_handler.py     # Обработка сообщений пользователей
│  ├─ admin_handler.py    # Обработка ответов администраторов
│  ├─ admin_edit.py       # Обработка редактирования ответов
│  └─ error_handler.py    # Глобальный обработчик ошибок
├─ utils/
│  ├─ helpers.py          # Вспомогательные функции
│  ├─ logger.py           # Логгер
│  └─ user_formatter.py   # Форматирование пользователей
├─ config.py              # Конфигурация (BOT_TOKEN, ADMINS_CHAT_ID)
├─ requirements.txt       # Зависимости проекта
└─ tgbot.py               # Точка входа и запуск бота
```
